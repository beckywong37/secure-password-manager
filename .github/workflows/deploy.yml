# GenAI Citation for April:
# Portions of this code related to Databases and Google Cloud were generated with
# the help of ChatGPT-5
# The conversation transcript [linked here](https://chatgpt.com/share/68fec1e7-10fc-8009-9bda-bdffef8ebea6)
# documents the GenAI Interaction that led to my code.
# See Pull Request here: https://github.com/beckywong37/secure-password-manager/pull/6

# Additionally, Portions of this code related to static file serving were generated with the help of Cursor with
#  Claude-4.5-sonnet model.
#  The conversation transcript linked below documents the GenAI Interaction that led to my code.
#  ../GenAI_transcripts/2025_11_16_Cursor_fixing_deploy_issues.md

# Additionally, portions of this code related to migrations and google cloud SQL proxies were generated with the
# help of Cursor with Claude-4.5-sonnet model.
# The conversation transcript linked below documents the GenAI Interaction that led to my code.
# ../GenAI_transcripts/2025_11_18_Cursor_fixing_gcloudSQL_tables.md

name: Deploy App Engine (auto on main, with migrations)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-app-engine
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      # App config for Django during CI steps.
      DEBUG: False
      DB_NAME: appdb
      DB_USER: appuser
      INSTANCE_CONNECTION_NAME: secure-password-manager-475618:us-central1:secure-password-manager-instance

      # Provided only for CI steps; the deployed service reads both from Secret Manager.
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      APPENGINE_URL: https://secure-password-manager-475618.uc.r.appspot.com/

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: gcloud CLI auth
        uses: google-github-actions/auth@v3
        with:
          project_id: 'secure-password-manager-475618'
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # Authenticate BEFORE starting the proxy (proxy uses ADC/IAM)
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'app-engine-python'

      # - name: Auth to GCP (SA key)
      #   uses: google-github-actions/auth@v3
      #   with:
      #     credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Download Cloud SQL Auth Proxy
        run: |
          curl -L -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.11.4/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

      - name: Start Cloud SQL Proxy
        run: |
          ./cloud-sql-proxy --port 5432 "$INSTANCE_CONNECTION_NAME" &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV
          # Wait for proxy to be ready
          echo "Waiting for Cloud SQL Proxy to be ready..."
          for i in {1..30}; do
            if nc -z 127.0.0.1 5432 2>/dev/null; then
              echo "Cloud SQL Proxy is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Cloud SQL Proxy failed to start"
              exit 1
            fi
            sleep 2
          done
      
      - name: Run migrations (against Cloud SQL via proxy)
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
        run: |
          # Sanity check DB settings
          python - <<'PY'
          import os, sys
          required = ["DB_NAME","DB_USER","DB_PASSWORD","DB_HOST","DB_PORT"]
          missing = [k for k in required if not os.environ.get(k)]
          if missing:
              print("Missing env:", missing); sys.exit(1)
          PY
          
          # Run migrations with verbose output
          echo "Running migrations..."
          python manage.py migrate --noinput --verbosity 2
          
          # Verify critical tables exist
          echo "Verifying database tables..."
          python - <<'PY'
          import os
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'password_manager.settings')
          import django
          django.setup()
          from django.db import connection
          
          with connection.cursor() as cursor:
              cursor.execute("""
                  SELECT tablename FROM pg_tables 
                  WHERE schemaname = 'public' 
                  AND tablename LIKE 'auth_service_%'
              """)
              tables = [row[0] for row in cursor.fetchall()]
              
          print(f"Found auth_service tables: {tables}")
          
          required_tables = ['auth_service_user']
          missing = [t for t in required_tables if t not in tables]
          
          if missing:
              print(f"ERROR: Required tables missing: {missing}")
              import sys
              sys.exit(1)
          
          print("âœ“ All required tables exist")
          PY

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'frontend/web/pnpm-lock.yaml'

      - name: Install frontend deps
        working-directory: ./frontend/web
        run: pnpm install

      - name: Build frontend
        working-directory: ./frontend/web
        run: pnpm run build

      - name: Collect static
        run: python manage.py collectstatic --noinput
        # Copies frontend/web/dist/ to static/ for WhiteNoise to serve

      - name: Deploy to App Engine
        id: deploy
        uses: google-github-actions/deploy-appengine@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          promote: true

      - name: Smoke test (hit new version URL)
        run: curl -sSfL "${{ steps.deploy.outputs.version_url }}" >/dev/null
